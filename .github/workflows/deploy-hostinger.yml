name: Deploy to Hostinger

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy Docker Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: assessor-de-lotacao:latest
          build-args: |
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: |
          echo "üì¶ Salvando imagem Docker..."
          docker save assessor-de-lotacao:latest -o image.tar
          echo "üì¶ Comprimindo imagem..."
          gzip -f image.tar
          echo "‚úÖ Imagem salva:"
          ls -lh image.tar.gz
          # Verificar se o arquivo foi criado corretamente
          if [ ! -f "image.tar.gz" ]; then
            echo "‚ùå Erro: Arquivo image.tar.gz n√£o foi criado!"
            exit 1
          fi
          # Verificar integridade do arquivo
          if ! gzip -t image.tar.gz; then
            echo "‚ùå Erro: Arquivo image.tar.gz est√° corrompido!"
            exit 1
          fi
          echo "‚úÖ Arquivo image.tar.gz v√°lido e pronto para upload"

      - name: üì§ Upload Docker image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          source: "image.tar.gz"
          target: ${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}

      - name: üì§ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          source: "docker-compose.yml"
          target: ${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}

      - name: üöÄ Deploy Docker container
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            set -e  # Exit on error
            
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}"
            CONTAINER_NAME="assessor-de-lotacao"
            IMAGE_NAME="assessor-de-lotacao:latest"
            
            cd "$DEPLOY_DIR" || exit 1
            
            # Verificar se Docker est√° instalado
            if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker n√£o est√° instalado no servidor!"
              echo "Por favor, instale o Docker primeiro."
              exit 1
            fi
            
            # Verificar se o arquivo existe e tem tamanho v√°lido
            if [ ! -f "image.tar.gz" ]; then
              echo "‚ùå Erro: Arquivo image.tar.gz n√£o encontrado!"
              exit 1
            fi
            
            FILE_SIZE=$(stat -f%z image.tar.gz 2>/dev/null || stat -c%s image.tar.gz 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -lt 1000 ]; then
              echo "‚ùå Erro: Arquivo image.tar.gz parece estar vazio ou corrompido (tamanho: $FILE_SIZE bytes)"
              exit 1
            fi
            
            echo "üì¶ Arquivo encontrado: $(du -h image.tar.gz | cut -f1)"
            
            # Verificar integridade do arquivo comprimido
            echo "üîç Verificando integridade do arquivo..."
            if ! gzip -t image.tar.gz 2>/dev/null; then
              echo "‚ùå Erro: Arquivo image.tar.gz est√° corrompido!"
              exit 1
            fi
            
            # Descomprimir e carregar imagem Docker
            echo "üì¶ Descomprimindo e carregando imagem Docker..."
            
            # M√©todo 1: Pipe direto (mais eficiente)
            if gunzip -c image.tar.gz | docker load 2>&1; then
              echo "‚úÖ Imagem carregada com sucesso (m√©todo pipe)!"
            else
              echo "‚ö†Ô∏è M√©todo pipe falhou, tentando m√©todo alternativo..."
              # M√©todo 2: Descomprimir primeiro, depois carregar
              gunzip -f image.tar.gz || {
                echo "‚ùå Erro ao descomprimir arquivo!"
                exit 1
              }
              
              if [ ! -f "image.tar" ]; then
                echo "‚ùå Erro: Arquivo image.tar n√£o foi criado ap√≥s descompress√£o!"
                exit 1
              fi
              
              docker load < image.tar || {
                echo "‚ùå Erro ao carregar imagem Docker!"
                echo "üìã Verificando Docker:"
                docker --version || true
                docker images | head -5 || true
                exit 1
              }
              
              echo "‚úÖ Imagem carregada com sucesso (m√©todo alternativo)!"
            fi
            
            # Verificar se a imagem foi carregada
            if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${IMAGE_NAME}$"; then
              echo "‚úÖ Imagem verificada no Docker: ${IMAGE_NAME}"
            else
              echo "‚ö†Ô∏è Imagem pode n√£o ter sido carregada corretamente"
              docker images | grep assessor || true
            fi
            
            # Parar e remover container antigo se existir
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "üõë Parando container existente..."
              docker stop "$CONTAINER_NAME" || true
              docker rm "$CONTAINER_NAME" || true
            fi
            
            # Criar e iniciar novo container
            echo "üöÄ Iniciando novo container..."
            docker run -d \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              -p 9966:9966 \
              "$IMAGE_NAME" || exit 1
            
            # Verificar se container est√° rodando
            sleep 5
            if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "‚ùå Container n√£o est√° rodando!"
              echo "üìã Logs do container:"
              docker logs "$CONTAINER_NAME" || true
              exit 1
            fi
            
            # Verificar sa√∫de do container
            echo "üè• Verificando sa√∫de do container..."
            sleep 10
            if docker exec "$CONTAINER_NAME" wget --quiet --tries=1 --spider http://localhost:9966; then
              echo "‚úÖ Container est√° saud√°vel!"
            else
              echo "‚ö†Ô∏è Container pode n√£o estar respondendo corretamente"
            fi
            
            # Limpar arquivos de imagem
            echo "üßπ Limpando arquivos tempor√°rios..."
            rm -f image.tar.gz image.tar || true
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üì¶ Container: $CONTAINER_NAME"
            echo "üåê Porta: 9966"
            echo "üìä Status:"
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Deploy Success Notification
        if: success()
        run: |
          echo "‚úÖ Deploy do container Docker conclu√≠do com sucesso na Hostinger!"
          echo "üåê Aplica√ß√£o dispon√≠vel na porta 9966"

