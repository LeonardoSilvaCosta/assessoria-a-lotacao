name: Deploy to Hostinger

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy Docker Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: assessor-de-lotacao:latest
          build-args: |
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: |
          docker save assessor-de-lotacao:latest | gzip > image.tar.gz

      - name: ğŸ“¤ Upload Docker image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          source: "image.tar.gz"
          target: ${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}

      - name: ğŸ“¤ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          source: "docker-compose.yml"
          target: ${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}

      - name: ğŸš€ Deploy Docker container
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            set -e  # Exit on error
            
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH || 'app/assessor-de-lotacao' }}"
            CONTAINER_NAME="assessor-de-lotacao"
            IMAGE_NAME="assessor-de-lotacao:latest"
            
            cd "$DEPLOY_DIR" || exit 1
            
            # Verificar se Docker estÃ¡ instalado
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker nÃ£o estÃ¡ instalado no servidor!"
              echo "Por favor, instale o Docker primeiro."
              exit 1
            fi
            
            # Carregar imagem Docker
            echo "ğŸ“¦ Carregando imagem Docker..."
            docker load < image.tar.gz || exit 1
            
            # Parar e remover container antigo se existir
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "ğŸ›‘ Parando container existente..."
              docker stop "$CONTAINER_NAME" || true
              docker rm "$CONTAINER_NAME" || true
            fi
            
            # Remover imagem antiga se existir (opcional)
            docker rmi "$IMAGE_NAME" 2>/dev/null || true
            
            # Criar e iniciar novo container
            echo "ğŸš€ Iniciando novo container..."
            docker run -d \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              -p 9966:9966 \
              "$IMAGE_NAME" || exit 1
            
            # Verificar se container estÃ¡ rodando
            sleep 5
            if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "âŒ Container nÃ£o estÃ¡ rodando!"
              echo "ğŸ“‹ Logs do container:"
              docker logs "$CONTAINER_NAME" || true
              exit 1
            fi
            
            # Verificar saÃºde do container
            echo "ğŸ¥ Verificando saÃºde do container..."
            sleep 10
            if docker exec "$CONTAINER_NAME" wget --quiet --tries=1 --spider http://localhost:9966; then
              echo "âœ… Container estÃ¡ saudÃ¡vel!"
            else
              echo "âš ï¸ Container pode nÃ£o estar respondendo corretamente"
            fi
            
            # Limpar arquivo de imagem
            rm -f image.tar.gz || true
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸ“¦ Container: $CONTAINER_NAME"
            echo "ğŸŒ Porta: 9966"
            echo "ğŸ“Š Status:"
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Deploy Success Notification
        if: success()
        run: |
          echo "âœ… Deploy do container Docker concluÃ­do com sucesso na Hostinger!"
          echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel na porta 9966"

